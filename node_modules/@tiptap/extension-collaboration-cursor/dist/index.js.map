{"version":3,"file":"index.js","sources":["../src/collaboration-cursor.ts"],"sourcesContent":["import { Extension } from '@tiptap/core'\nimport { yCursorPlugin } from 'y-prosemirror'\n\ntype CollaborationCursorStorage = {\n  users: { clientId: number, [key: string]: any }[],\n}\n\nexport interface CollaborationCursorOptions {\n  provider: any,\n  user: Record<string, any>,\n  render (user: Record<string, any>): HTMLElement,\n  /**\n   * @deprecated The \"onUpdate\" option is deprecated. Please use `editor.storage.collaborationCursor.users` instead. Read more: https://tiptap.dev/api/extensions/collaboration-cursor\n   */\n  onUpdate: (users: { clientId: number, [key: string]: any }[]) => null,\n}\n\ndeclare module '@tiptap/core' {\n  interface Commands<ReturnType> {\n    collaborationCursor: {\n      /**\n       * Update details of the current user\n       */\n      updateUser: (attributes: Record<string, any>) => ReturnType,\n      /**\n       * Update details of the current user\n       *\n       * @deprecated The \"user\" command is deprecated. Please use \"updateUser\" instead. Read more: https://tiptap.dev/api/extensions/collaboration-cursor\n       */\n      user: (attributes: Record<string, any>) => ReturnType,\n    }\n  }\n}\n\nconst awarenessStatesToArray = (states: Map<number, Record<string, any>>) => {\n  return Array.from(states.entries()).map(([key, value]) => {\n    return {\n      clientId: key,\n      ...value.user,\n    }\n  })\n}\n\nconst defaultOnUpdate = () => null\n\nexport const CollaborationCursor = Extension.create<CollaborationCursorOptions, CollaborationCursorStorage>({\n  name: 'collaborationCursor',\n\n  addOptions() {\n    return {\n      provider: null,\n      user: {\n        name: null,\n        color: null,\n      },\n      render: user => {\n        const cursor = document.createElement('span')\n\n        cursor.classList.add('collaboration-cursor__caret')\n        cursor.setAttribute('style', `border-color: ${user.color}`)\n\n        const label = document.createElement('div')\n\n        label.classList.add('collaboration-cursor__label')\n        label.setAttribute('style', `background-color: ${user.color}`)\n        label.insertBefore(document.createTextNode(user.name), null)\n        cursor.insertBefore(label, null)\n\n        return cursor\n      },\n      onUpdate: defaultOnUpdate,\n    }\n  },\n\n  onCreate() {\n    if (this.options.onUpdate !== defaultOnUpdate) {\n      console.warn('[tiptap warn]: DEPRECATED: The \"onUpdate\" option is deprecated. Please use `editor.storage.collaborationCursor.users` instead. Read more: https://tiptap.dev/api/extensions/collaboration-cursor')\n    }\n  },\n\n  addStorage() {\n    return {\n      users: [],\n    }\n  },\n\n  addCommands() {\n    return {\n      updateUser: attributes => () => {\n        this.options.user = attributes\n\n        this.options.provider.awareness.setLocalStateField('user', this.options.user)\n\n        return true\n      },\n      user: attributes => ({ editor }) => {\n        console.warn('[tiptap warn]: DEPRECATED: The \"user\" command is deprecated. Please use \"updateUser\" instead. Read more: https://tiptap.dev/api/extensions/collaboration-cursor')\n\n        return editor.commands.updateUser(attributes)\n      },\n    }\n  },\n\n  addProseMirrorPlugins() {\n    return [\n      yCursorPlugin(\n        (() => {\n          this.options.provider.awareness.setLocalStateField('user', this.options.user)\n\n          this.storage.users = awarenessStatesToArray(this.options.provider.awareness.states)\n\n          this.options.provider.awareness.on('update', () => {\n            this.storage.users = awarenessStatesToArray(this.options.provider.awareness.states)\n          })\n\n          return this.options.provider.awareness\n        })(),\n        // @ts-ignore\n        {\n          cursorBuilder: this.options.render,\n        },\n      ),\n    ]\n  },\n})\n"],"names":[],"mappings":"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"}