{"version":3,"file":"index.js","sources":["../src/collaboration.ts","../src/helpers/isChangeOrigin.ts"],"sourcesContent":["import { Extension } from '@tiptap/core'\nimport {\n  redo,\n  undo,\n  ySyncPlugin,\n  yUndoPlugin,\n  yUndoPluginKey,\n} from 'y-prosemirror'\nimport { UndoManager } from 'yjs'\n\ndeclare module '@tiptap/core' {\n  interface Commands<ReturnType> {\n    collaboration: {\n      /**\n       * Undo recent changes\n       */\n      undo: () => ReturnType,\n      /**\n       * Reapply reverted changes\n       */\n      redo: () => ReturnType,\n    }\n  }\n}\n\nexport interface CollaborationOptions {\n  /**\n   * An initialized Y.js document.\n   */\n  document: any,\n  /**\n   * Name of a Y.js fragment, can be changed to sync multiple fields with one Y.js document.\n   */\n  field: string,\n  /**\n   * A raw Y.js fragment, can be used instead of `document` and `field`.\n   */\n  fragment: any,\n}\n\nexport const Collaboration = Extension.create<CollaborationOptions>({\n  name: 'collaboration',\n\n  priority: 1000,\n\n  addOptions() {\n    return {\n      document: null,\n      field: 'default',\n      fragment: null,\n    }\n  },\n\n  onCreate() {\n    if (this.editor.extensionManager.extensions.find(extension => extension.name === 'history')) {\n      console.warn('[tiptap warn]: \"@tiptap/extension-collaboration\" comes with its own history support and is not compatible with \"@tiptap/extension-history\".')\n    }\n  },\n\n  addCommands() {\n    return {\n      undo: () => ({ tr, state, dispatch }) => {\n        tr.setMeta('preventDispatch', true)\n\n        const undoManager: UndoManager = yUndoPluginKey.getState(state).undoManager\n\n        if (undoManager.undoStack.length === 0) {\n          return false\n        }\n\n        if (!dispatch) {\n          return true\n        }\n\n        return undo(state)\n      },\n      redo: () => ({ tr, state, dispatch }) => {\n        tr.setMeta('preventDispatch', true)\n\n        const undoManager: UndoManager = yUndoPluginKey.getState(state).undoManager\n\n        if (undoManager.redoStack.length === 0) {\n          return false\n        }\n\n        if (!dispatch) {\n          return true\n        }\n\n        return redo(state)\n      },\n    }\n  },\n\n  addKeyboardShortcuts() {\n    return {\n      'Mod-z': () => this.editor.commands.undo(),\n      'Mod-y': () => this.editor.commands.redo(),\n      'Shift-Mod-z': () => this.editor.commands.redo(),\n    }\n  },\n\n  addProseMirrorPlugins() {\n    const fragment = this.options.fragment\n      ? this.options.fragment\n      : this.options.document.getXmlFragment(this.options.field)\n\n    return [\n      ySyncPlugin(fragment),\n      yUndoPlugin(),\n    ]\n  },\n})\n","import { Transaction } from '@tiptap/pm/state'\nimport { ySyncPluginKey } from 'y-prosemirror'\n\nexport function isChangeOrigin(transaction: Transaction): boolean {\n  return !!transaction.getMeta(ySyncPluginKey)\n}\n"],"names":[],"mappings":";;;AAwCa,MAAA,aAAa,GAAG,SAAS,CAAC,MAAM,CAAuB;AAClE,IAAA,IAAI,EAAE,eAAe;AAErB,IAAA,QAAQ,EAAE,IAAI;IAEd,UAAU,GAAA;QACR,OAAO;AACL,YAAA,QAAQ,EAAE,IAAI;AACd,YAAA,KAAK,EAAE,SAAS;AAChB,YAAA,QAAQ,EAAE,IAAI;SACf,CAAA;KACF;IAED,QAAQ,GAAA;QACN,IAAI,IAAI,CAAC,MAAM,CAAC,gBAAgB,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,IAAI,SAAS,CAAC,IAAI,KAAK,SAAS,CAAC,EAAE;AAC3F,YAAA,OAAO,CAAC,IAAI,CAAC,6IAA6I,CAAC,CAAA;AAC5J,SAAA;KACF;IAED,WAAW,GAAA;QACT,OAAO;AACL,YAAA,IAAI,EAAE,MAAM,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,KAAI;AACtC,gBAAA,EAAE,CAAC,OAAO,CAAC,iBAAiB,EAAE,IAAI,CAAC,CAAA;gBAEnC,MAAM,WAAW,GAAgB,cAAc,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,WAAW,CAAA;AAE3E,gBAAA,IAAI,WAAW,CAAC,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE;AACtC,oBAAA,OAAO,KAAK,CAAA;AACb,iBAAA;gBAED,IAAI,CAAC,QAAQ,EAAE;AACb,oBAAA,OAAO,IAAI,CAAA;AACZ,iBAAA;AAED,gBAAA,OAAO,IAAI,CAAC,KAAK,CAAC,CAAA;aACnB;AACD,YAAA,IAAI,EAAE,MAAM,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,KAAI;AACtC,gBAAA,EAAE,CAAC,OAAO,CAAC,iBAAiB,EAAE,IAAI,CAAC,CAAA;gBAEnC,MAAM,WAAW,GAAgB,cAAc,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,WAAW,CAAA;AAE3E,gBAAA,IAAI,WAAW,CAAC,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE;AACtC,oBAAA,OAAO,KAAK,CAAA;AACb,iBAAA;gBAED,IAAI,CAAC,QAAQ,EAAE;AACb,oBAAA,OAAO,IAAI,CAAA;AACZ,iBAAA;AAED,gBAAA,OAAO,IAAI,CAAC,KAAK,CAAC,CAAA;aACnB;SACF,CAAA;KACF;IAED,oBAAoB,GAAA;QAClB,OAAO;YACL,OAAO,EAAE,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,EAAE;YAC1C,OAAO,EAAE,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,EAAE;YAC1C,aAAa,EAAE,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,EAAE;SACjD,CAAA;KACF;IAED,qBAAqB,GAAA;AACnB,QAAA,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ;AACpC,cAAE,IAAI,CAAC,OAAO,CAAC,QAAQ;AACvB,cAAE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAA;QAE5D,OAAO;YACL,WAAW,CAAC,QAAQ,CAAC;AACrB,YAAA,WAAW,EAAE;SACd,CAAA;KACF;AACF,CAAA;;AC7GK,SAAU,cAAc,CAAC,WAAwB,EAAA;IACrD,OAAO,CAAC,CAAC,WAAW,CAAC,OAAO,CAAC,cAAc,CAAC,CAAA;AAC9C;;;;"}